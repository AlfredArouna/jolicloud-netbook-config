#!/usr/bin/perl

use Data::Dumper;

my $channel = "";
my $mixer = {};

my $VERBOSE = 0;
my $DRYRUN = 0;
my $DEBUG = 0;

my $config = {
    "'Master',0" => {    pvolume => "90%",  pswitch => "unmute" },
    "'PCM',0" => {       pvolume => "100%", pswitch => "unmute", },
    "'Headphone',0" => { pvolume => "100%", pswitch => "unmute", },
    "'Speaker',0" => {   pvolume => "100%", pswitch => "unmute", },
    "'PC Beep',0" => {   pvolume => "0%",   pswitch => "mute", },
    "'Capture',0" => {   cvolume => "100%", cswitch => "cap", },
    "'Front Mic',0" => { cvolume => "90%",  cswitch => "cap", },
    "'i-Mic',0" => {     cvolume => "90%",  cswitch => "cap", },
    "'Line In',0" => {   cvolume => "90%",  cswitch => "cap", },
};

while ( my $arg = shift ) {
    if ( $arg eq "-D" ) {
        $DEBUG = 1;
    }
    elsif ( $arg eq "-d" ) {
        $DRYRUN = 1;
    }
    elsif ( $arg eq "-v" ) {
        $VERBOSE = 1;
    }
}

foreach my $line ( `amixer` ) {
    chomp;
    if ( $line =~ /^Simple mixer control ('.*?',(\d))$/ ) {
        # Skip channels that do not end in 0
        $channel = ( $2 eq "0" ) ? $1 : "";
    }
    elsif ( $channel && $line =~ /^  (.*?): (.*?)$/ ) {
        my ( $key, $val ) = ( $1, $2 );
        if ( ( $key eq "Capabilities" ) ||
             ( $key =~ "Items" ) ) {
            if ( $val =~ s/^'(.*?)'$/$1/ ) {
                $val = [ split( "' '", $val ) ];
            }
            else {
                $val = [ split( " ", $val ) ];
            }
        }
        elsif ( $key eq "Item0" ) {
            $val =~ s/^'(.*?)'$/$1/;
        }
        $mixer->{ $channel }->{ $key } = $val;
    }
}

print Dumper( $mixer ) if ( $DEBUG );

while ( ( $channel, $data ) = each %{ $mixer } ) {
    my @sset;

    if ( exists $config->{ $channel } ) {
        # Load the global config
        my $cfg = $config->{ $channel };

        # Load any device-specific config

        while ( my ( $capability, $setting ) = each %{ $cfg } ) {
            if ( &isin( $capability, $data->{ 'Capabilities' } ) ) {
                push( @sset, $setting );
            }
        }
    }

    if ( @sset ) {
        my $cmd = "/usr/bin/amixer sset $channel " . join( ' ', @sset );
        print "$cmd\n" if ( $VERBOSE );
        print `$cmd` . "\n" if ( ! $DRYRUN );
    }
}



sub isin
{
    my ( $needle, $haystack ) = @_;
    return grep( $_ eq $needle, @{ $haystack } );
}

